#!/usr/bin/env bash

# Compare the flags generated by generate-flags.sh with a "known good" set of flags obtained from an older version of generate-flags.sh

# Make it so --param=<name>=<value> is converted to --param=<name>
# (we now make --param values way higher, so if we don't do this, every --param value would differ...)
# We also make this into a function so it can be easily turned off if needed
filter-out-param-values() {
    sed -E 's/--param=([^=]+)=.*/--param=\1/'
}

process-flags-for-comm() {
    # First tr: We need to convert the output from space-separated to newline-separated for comm to be able to compare lines
    # sort: comm requires sorted input
    tr ' ' '\n' | filter-out-param-values | grep . | sort
}

echo gcc-x86-64:
comm -3 <(./generate-flags.sh gcc-x86-64-all-architectural-features-fast-math | process-flags-for-comm) <(echo '-std=gnu++2c -pthread -fexceptions -frtti -fasm -fgnu-keywords -fext-numeric-literals -fgnu-tm -flax-vector-conversions -fms-extensions -fcontracts -fcoroutines -fmodules -ftemplate-depth=900000 -fopenacc -fopenmp-simd -fopenmp -fpermissive -freg-struct-return -fbuiltin -fnonansi-builtins -fstrict-flex-arrays=3 -fstrict-enums -fstrict-aliasing -fstrict-overflow -O3 -fomit-frame-pointer -fmodulo-sched -fmodulo-sched-allow-regmoves -fgcse-sm -fgcse-las -fdelete-null-pointer-checks -fdevirtualize-speculatively -fdevirtualize-at-ltrans -free -flive-range-shrinkage -flate-combine-instructions -fvariable-expansion-in-unroller -ftrivial-auto-var-init=uninitialized -fvariable-expansion-in-unroller -fprefetch-loop-arrays -freorder-blocks-and-partition -fallocation-dce -fmalloc-dce=2 -fno-unreachable-traps -fweb -frename-registers -ftracer -fsplit-loops -funswitch-loops -fstdarg-opt -fsection-anchors -fira-algorithm=CB -fira-hoist-pressure -fira-loop-pressure -fschedule-insns -fschedule-insns2 -fschedule-fusion -fsched-pressure -fsched-spec-load -fsched-spec-load-dangerous -fsched2-use-superblocks -fipa-ra -fipa-pta -fipa-cp -fipa-bit-cp -fipa-vrp -fipa-icf -fipa-reorder-for-locality -ftree-cselim -ftree-builtin-call-dce -ftree-coalesce-vars -free -ftree-loop-if-convert -ftree-loop-im -ftree-loop-ivcanon -fivopts -ftree-vectorize -ftree-loop-linear -floop-strip-mine -floop-block -fgraphite-identity -floop-nest-optimize -flto=auto -ffat-lto-objects --param=max-crossjump-edges=100000 --param=max-goto-duplication-insns=8888 --param=max-delay-slot-insn-search=100000 --param=max-delay-slot-live-search=333333 --param=max-gcse-memory=134217728 --param=max-pending-list-length=32768 --param=max-modulo-backtrack-attempts=40000 --param=modref-max-bases=32768 --param=modref-max-refs=16384 --param=modref-max-accesses=16384 --param=modref-max-tests=65536 --param=modref-max-depth=65536 --param=modref-max-escape-points=262144 --param=modref-max-adjustments=254 --param=max-hoist-depth=300000 --param=max-tail-merge-comparisons=10000 --param=max-tail-merge-iterations=2000 --param=max-stores-to-merge=65536 --param=max-store-chains-to-track=65536 --param=max-stores-to-track=1048576 --param=iv-consider-all-candidates-bound=40000 --param=iv-max-considered-uses=250000 --param=dse-max-object-size=262144 --param=dse-max-alias-queries-per-store=262144 --param=scev-max-expr-size=100000 --param=scev-max-expr-complexity=10000 --param=vect-max-layout-candidates=32768 --param=max-iterations-to-track=10000000 --param=max-cse-path-length=65536 --param=max-cse-insns=1000000 --param=max-reload-search-insns=100000 --param=max-cselib-memory-locations=500000 --param=max-sched-ready-insns=65536 --param=max-sched-region-blocks=10000 --param=max-pipeline-region-blocks=16384 --param=max-sched-region-insns=200000 --param=max-pipeline-region-insns=200000 --param=max-sched-extend-regions-iters=1000000 --param=selsched-max-lookahead=50000 --param=selsched-max-sched-times=65536 --param=selsched-insns-to-rename=20000 --param=max-last-value-rtl=10000000 --param=max-combine-search-insns=3000000 --param=max-jump-thread-paths=65536 --param=max-partial-antic-length=1000000 --param=sccvn-max-alias-queries-per-access=1000000 --param=ira-max-loops-num=100000 --param=ira-max-conflict-table-size=1000000 --param=ira-simple-lra-insn-threshold=1000000 --param=loop-invariant-max-bbs-in-loop=10000000 --param=loop-max-datarefs-for-datadeps=1000000 --param=max-vartrack-size=1000000000 --param=max-vartrack-expr-depth=12000 --param=max-debug-marker-count=100000000 --param=ipa-sra-max-replacements=16 --param=graphite-max-nb-scop-params=10000 --param=ipa-jump-function-lookups=8000 --param=ipa-cp-value-list-size=8000 --param=ipa-max-aa-steps=25000000 --param=ipa-max-switch-predicate-bounds=5000 --param=ipa-max-param-expr-ops=10000 --param=cxx-max-namespaces-for-diagnostic-help=1000000 --param=sched-pressure-algorithm=2 --param=max-slsr-cand-scan=999999 --param=max-ssa-name-query-depth=10 --param=max-speculative-devirt-maydefs=50000 --param=max-tracked-strlens=10000000 --param=vrp-block-limit=150000000 --param=vrp-sparse-threshold=3000000 --param=vrp-switch-limit=50000 --param=sms-dfa-history=16 --param=lra-max-considered-reload-pseudos=500000 --param=max-pow-sqrt-depth=32 --param=max-dse-active-local-stores=5000000 --param=max-isl-operations=350000000 --param=graphite-max-arrays-per-scop=100000 --param=max-vartrack-reverse-op-size=50000 --param=uninit-control-dep-attempts=65536 --param=uninit-max-chain-len=128 --param=uninit-max-num-chains=128 --param=ssa-name-def-chain-limit=524288 --param=max-find-base-term-values=200000 --param=ranger-logical-depth=999 --param=ranger-recompute-depth=100 --param=relation-block-limit=9999 --param=transitive-relations-work-bound=9999 --param=x86-stv-max-visits=1000000 --param=max-early-inliner-iterations=1000 --param=max-fields-for-field-sensitive=100000 --param=sra-max-propagations=32768 -g0 -ffast-math -fallow-store-data-races -fno-semantic-interposition -ffp-contract=fast -ffinite-loops -fexcess-precision=fast -fno-float-store -ffast-math -fno-math-errno -funsafe-math-optimizations -fassociative-math -freciprocal-math -ffinite-math-only -fno-signed-zeros -fno-trapping-math -fno-rounding-math -fno-signaling-nans -ffp-int-builtin-inexact -fcx-fortran-rules -fcx-limited-range -fcx-method=limited-range -march=x86-64-v4 -mfpmath=both -masm=intel -mieee-fp -mhard-float -mmmx -msse -msse2 -msse3 -mssse3 -msse4 -msse4a -msse4.1 -msse4.2 -mavx -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq -mavx512ifma -mavx512vbmi -msha -maes -mpclmul -mclflushopt -mclwb -mfsgsbase -mptwrite -mrdrnd -mf16c -mfma -mpconfig -mwbnoinvd -mfma4 -mprfchw -mrdpid -mrdseed -msgx -mxop -mlwp -m3dnow -m3dnowa -mpopcnt -madx -mbmi -mbmi2 -mlzcnt -mfxsr -mxsave -mxsaveopt -mxsavec -mxsaves -mrtm -mhle -mtbm -mmwaitx -mclzero -mpku -mavx512vbmi2 -mavx512bf16 -mavx512fp16 -mgfni -mvaes -mwaitpkg -mvpclmulqdq -mavx512bitalg -mmovdiri -mmovdir64b -menqcmd -muintr -mtsxldtrk -mavx512vpopcntdq -mavx512vp2intersect -mavx512vnni -mavxvnni -mcldemote -mserialize -mamx-tile -mamx-int8 -mamx-bf16 -mhreset -mkl -mwidekl -mavxifma -mavxvnniint8 -mavxneconvert -mcmpccxadd -mamx-fp16 -mprefetchi -mraoint -mamx-complex -mavxvnniint16 -msm3 -msha512 -msm4 -mapxf -musermsr -mavx10.1 -mavx10.2 -mamx-avx512 -mamx-tf32 -mamx-transpose -mamx-fp8 -mmovrs -mamx-movrs -mtune-ctrl=^avoid_false_dep_for_tzcnt,^avoid_false_dep_for_bls,^avoid_false_dep_for_bmi,^lcp_stall,use_incdec,use_himode_fiop,use_simode_fiop,use_ffreep,ext_80387_constants,use_gather_2parts,use_scatter_2parts,use_gather_4parts,use_scatter_4parts,use_gather_8parts,use_scatter_8parts,^avoid_fma512_chains,avx512_move_by_pieces,avx512_store_by_pieces,avx512_two_epilogues -mprefer-vector-width=512 -mmove-max=512 -mstore-max=512 -mnoreturn-no-callee-saved-registers -mcx16 -msahf -mmovbe -mshstk -mcrc32 -mmwait -mabi=sysv -mtls-dialect=gnu2 -momit-leaf-frame-pointer -mneeded -m64 -fno-section-anchors' | process-flags-for-comm)
