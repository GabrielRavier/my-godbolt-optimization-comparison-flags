#!/usr/bin/env bash

# Compare the flags generated by generate-flags.sh with a "known good" set of flags obtained from an older version of generate-flags.sh

# Make it so --param=<name>=<value> is converted to --param=<name>
# (we now make --param values way higher, so if we don't do this, every --param value would differ...)
# We also make this into a function so it can be easily turned off if needed
filter-out-param-values() {
    sed -E 's/--param=([^=]+)=.*/--param=\1/'
}

process-flags-for-comm() {
    # First tr: We need to convert the output from space-separated to newline-separated for comm to be able to compare lines
    # sort: comm requires sorted input
    tr ' ' '\n' | filter-out-param-values | grep . | sort
}

printf 'gcc-x86-64:\n'
comm -3 <(./generate-flags.sh gcc-x86-64 | process-flags-for-comm) <(echo '-std=gnu++98 -pthread -fexceptions -frtti -fasm -fgnu-keywords -fms-extensions -fpermissive -freg-struct-return -std=gnu++0x -flax-vector-conversions -fopenmp -ftemplate-depth=900000 -fgnu-tm -std=gnu++1y -fext-numeric-literals -fopenmp-simd -std=gnu++1z -fopenacc -std=gnu++2a -fcoroutines -std=gnu++2b -fcontracts -std=gnu++2c -fmodules -fbuiltin -fnonansi-builtins -fstrict-aliasing -O3 -fomit-frame-pointer -fgcse-sm -fgcse-las -fdelete-null-pointer-checks -fprefetch-loop-arrays -freorder-blocks-and-partition -fweb -frename-registers -ftracer -funswitch-loops -fschedule-insns -fschedule-insns2 -fsched-spec-load -fsched-spec-load-dangerous -fsched2-use-superblocks -ftree-loop-im -ftree-loop-ivcanon -ftree-vectorize -fmodulo-sched -fvariable-expansion-in-unroller -fivopts -fipa-cp -fstrict-overflow -fmodulo-sched-allow-regmoves -fsection-anchors -fira-algorithm=CB -fipa-pta -ftree-cselim -ftree-builtin-call-dce -fira-loop-pressure -fsched-pressure -fstrict-enums -ftree-loop-if-convert -free -flto=auto -ffat-lto-objects -fira-hoist-pressure -ftree-coalesce-vars -fdevirtualize-speculatively -flive-range-shrinkage -ftree-loop-linear -floop-strip-mine -floop-block -floop-nest-optimize -fgraphite-identity -fdevirtualize-at-ltrans -fstdarg-opt -fschedule-fusion -fipa-ra -fipa-icf -fsplit-loops -fipa-bit-cp -fipa-vrp -fallocation-dce -ftrivial-auto-var-init=uninitialized -fstrict-flex-arrays=3 -fno-unreachable-traps -flate-combine-instructions -fmalloc-dce=2 -fipa-reorder-for-locality -ffast-math -fno-float-store -ffast-math -fno-math-errno -funsafe-math-optimizations -ffinite-math-only -fno-trapping-math -fno-rounding-math -fno-signaling-nans -fcx-limited-range -fassociative-math -freciprocal-math -fno-signed-zeros -fcx-fortran-rules -fexcess-precision=fast -ffp-contract=fast -fno-semantic-interposition -ffp-int-builtin-inexact -fallow-store-data-races -ffinite-loops -fcx-method=limited-range --param=max-crossjump-edges=100000 --param=max-delay-slot-insn-search=100000 --param=max-delay-slot-live-search=333333 --param=max-gcse-memory=134217728 --param=max-pending-list-length=32768 --param=max-reload-search-insns=100000 --param=max-cselib-memory-locations=500000 --param=max-last-value-rtl=10000000 --param=max-cse-path-length=65536 --param=max-goto-duplication-insns=8888 --param=max-iterations-to-track=10000000 --param=max-sched-region-insns=200000 --param=iv-consider-all-candidates-bound=40000 --param=iv-max-considered-uses=250000 --param=scev-max-expr-size=100000 --param=sms-dfa-history=16 --param=max-fields-for-field-sensitive=100000 --param=max-cse-insns=1000000 --param=max-sched-ready-insns=65536 --param=max-sched-region-blocks=10000 --param=max-pipeline-region-blocks=16384 --param=max-pipeline-region-insns=200000 --param=max-sched-extend-regions-iters=1000000 --param=selsched-max-lookahead=50000 --param=selsched-max-sched-times=65536 --param=selsched-insns-to-rename=20000 --param=ira-max-loops-num=100000 --param=ira-max-conflict-table-size=1000000 --param=max-partial-antic-length=1000000 --param=loop-invariant-max-bbs-in-loop=10000000 --param=max-early-inliner-iterations=1000 --param=max-vartrack-size=1000000000 --param=graphite-max-nb-scop-params=10000 --param=max-hoist-depth=300000 --param=max-dse-active-local-stores=5000000 --param=scev-max-expr-complexity=10000 --param=cxx-max-namespaces-for-diagnostic-help=1000000 --param=max-modulo-backtrack-attempts=40000 --param=max-tracked-strlens=10000000 --param=max-vartrack-expr-depth=12000 --param=max-tail-merge-comparisons=10000 --param=max-tail-merge-iterations=2000 --param=loop-max-datarefs-for-datadeps=1000000 --param=ipa-cp-value-list-size=8000 --param=max-slsr-cand-scan=999999 --param=sccvn-max-alias-queries-per-access=1000000 --param=max-vartrack-reverse-op-size=50000 --param=sched-pressure-algorithm=2 --param=uninit-control-dep-attempts=65536 --param=lra-max-considered-reload-pseudos=500000 --param=ipa-max-aa-steps=25000000 --param=graphite-max-arrays-per-scop=100000 --param=max-ssa-name-query-depth=10 --param=max-speculative-devirt-maydefs=50000 --param=max-pow-sqrt-depth=32 --param=max-isl-operations=350000000 --param=max-stores-to-merge=65536 --param=dse-max-object-size=262144 --param=max-debug-marker-count=100000000 --param=dse-max-alias-queries-per-store=262144 --param=ssa-name-def-chain-limit=524288 --param=sra-max-propagations=32768 --param=ipa-sra-max-replacements=16 --param=ipa-max-switch-predicate-bounds=5000 --param=ipa-max-param-expr-ops=10000 --param=max-find-base-term-values=200000 --param=modref-max-bases=32768 --param=modref-max-refs=16384 --param=modref-max-accesses=16384 --param=modref-max-tests=65536 --param=modref-max-depth=65536 --param=modref-max-escape-points=262144 --param=max-store-chains-to-track=65536 --param=max-stores-to-track=1048576 --param=ipa-jump-function-lookups=8000 --param=ranger-logical-depth=999 --param=modref-max-adjustments=254 --param=relation-block-limit=9999 --param=vect-max-layout-candidates=32768 --param=max-jump-thread-paths=65536 --param=ira-simple-lra-insn-threshold=1000000 --param=ranger-recompute-depth=100 --param=uninit-max-chain-len=128 --param=uninit-max-num-chains=128 --param=vrp-sparse-threshold=3000000 --param=vrp-switch-limit=50000 --param=max-combine-search-insns=3000000 --param=vrp-block-limit=150000000 --param=transitive-relations-work-bound=9999 -g0 -mieee-fp -mhard-float -mmmx -m3dnow -msse -msse2 -msse3 -momit-leaf-frame-pointer -masm=intel -march=barcelona -mtune=generic -mfpmath=both -mssse3 -msse4 -msse4a -msse4.1 -msse4.2 -mavx -mpopcnt -maes -mpclmul -mfma -mcx16 -msahf -mtls-dialect=gnu2 -fno-section-anchors -mfma4 -mxop -mlwp -mmovbe -mcrc32 -march=core-avx-i -mbmi -mrdrnd -mtbm -mfsgsbase -mf16c -mabi=sysv -march=core-avx2 -mavx2 -mbmi2 -mlzcnt -mfxsr -mxsave -mxsaveopt -mrdseed -madx -mrtm -mhle -mprfchw -march=broadwell -mavx512f -mavx512cd -msha -mavx512vl -mavx512bw -mavx512dq -mavx512ifma -mavx512vbmi -mclflushopt -mclwb -mxsavec -mxsaves -mmwaitx -march=skylake-avx512 -mclzero -mpku -mavx512vpopcntdq -m3dnowa -mrdpid -msgx -march=icelake-server -mavx512vbmi2 -mavx512bitalg -mavx512vnni -mmovdiri -mmovdir64b -mpconfig -mwbnoinvd -mgfni -mvaes -mvpclmulqdq -mshstk -mprefer-vector-width=512 -mptwrite -mwaitpkg -mcldemote -march=tigerlake -mavx512bf16 -mavx512vp2intersect -menqcmd -march=x86-64-v4 -mavxvnni -mamx-tile -mamx-int8 -mamx-bf16 -mkl -mwidekl -muintr -mtsxldtrk -mserialize -mhreset -mneeded -mmwait -mavx512fp16 -mmove-max=512 -mstore-max=512 -mavxifma -mavxvnniint8 -mavxneconvert -mamx-fp16 -mamx-complex -mcmpccxadd -mprefetchi -mraoint --param=x86-stv-max-visits=1000000 -mavxvnniint16 -msm3 -msm4 -mavx10.1 -msha512 -mapxf -musermsr -mnoreturn-no-callee-saved-registers -mavx10.2 -mamx-avx512 -mamx-tf32 -mamx-transpose -mamx-fp8 -mmovrs -mamx-movrs -mtune-ctrl=^lcp_stall,use_incdec,use_himode_fiop,use_simode_fiop,use_ffreep,ext_80387_constants,^avoid_false_dep_for_bmi,use_gather_2parts,use_gather_4parts,avx512_move_by_pieces,avx512_store_by_pieces,use_scatter_2parts,use_scatter_4parts,^avoid_fma512_chains,use_gather_8parts,use_scatter_8parts,^avoid_false_dep_for_tzcnt,^avoid_false_dep_for_bls,avx512_two_epilogues -m64' | process-flags-for-comm)

printf '\nclang-x86-64:\n'
comm -3 <(./generate-flags.sh clang-x86-64 | process-flags-for-comm) <(echo '-O3 -ffast-math -fno-trapping-math -ffp-contract=fast -fstrict-flex-arrays=3 -fdelete-null-pointer-checks -mllvm -polly -ffp-model=fast -fno-signed-zeros -fno-honor-nans -fno-semantic-interposition -fno-pie -std=gnu++2a -fopenmp-simd -g0 -march=x86-64-v4 -mmmx -msse -msse2 -msse3 -mssse3 -msse4 -msse4a -msse4.1 -msse4.2 -mavx -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq -mavx512ifma -mavx512vbmi -msha -maes -mpclmul -mclflushopt -mclwb -mfsgsbase -mptwrite -mrdrnd -mf16c -mfma -mpconfig -mwbnoinvd -mfma4 -mprfchw -mrdpid -mrdseed -msgx -mxop -mlwp -mpopcnt -madx -mbmi -mbmi2 -mlzcnt -mfxsr -mxsave -mxsaveopt -mxsavec -mxsaves -mrtm -mtbm -mmwaitx -mclzero -mpku -mavx512vbmi2 -mavx512bf16 -mavx512fp16 -mgfni -mvaes -mwaitpkg -mvpclmulqdq -mavx512bitalg -mmovdiri -mmovdir64b -menqcmd -muintr -mtsxldtrk -mavx512vpopcntdq -mavx512vp2intersect -mavx512vnni -mavxvnni -mcldemote -mserialize -mamx-tile -mamx-int8 -mamx-bf16 -mhreset -mkl -mwidekl -mavxifma -mavxvnniint8 -mavxneconvert -mcmpccxadd -mamx-fp16 -mprefetchi -mraoint -mamx-complex -mavxvnniint16 -msm3 -msha512 -msm4 -musermsr -mavx10.1 -mavx10.1-256 -mavx10.1-512 -mcx16 -msahf -mmovbe -mshstk -mcrc32 -mevex512 -mapxf -mprefer-vector-width=512' | process-flags-for-comm)

printf '\ngcc-x86-32:\n'
comm -3 <(./generate-flags.sh gcc-x86-32 | process-flags-for-comm) <(echo '-m32 -O3 -ffast-math -fno-trapping-math -ffp-contract=fast -fstrict-flex-arrays=3 -fmodulo-sched -fmodulo-sched-allow-regmoves -fgcse-sm -fgcse-las -fdevirtualize-at-ltrans -flive-range-shrinkage -fira-hoist-pressure -fira-loop-pressure -fsched-pressure -fsched-spec-load -fsched-spec-load-dangerous -fsched2-use-superblocks -fno-semantic-interposition -fipa-pta -fdelete-null-pointer-checks -fgraphite-identity -floop-strip-mine -ftree-loop-linear -floop-block -floop-nest-optimize -ftree-loop-if-convert -ftree-loop-im -ftree-loop-ivcanon -fivopts -ftree-vectorize -freorder-blocks-and-partition -fweb -fassociative-math -freciprocal-math -fno-signed-zeros -ffp-int-builtin-inexact -frename-registers -fsplit-loops -funswitch-loops -fstdarg-opt -fdevirtualize-speculatively -free -ffinite-loops -fvariable-expansion-in-unroller -fno-unreachable-traps --param=max-crossjump-edges=300 --param=max-goto-duplication-insns=100 --param=max-delay-slot-insn-search=1000 --param=max-delay-slot-live-search=3333 --param=max-gcse-memory=300000 --param=max-pending-list-length=320 --param=max-modulo-backtrack-attempts=100 --param=max-early-inliner-iterations=10 --param=modref-max-tests=640 --param=modref-max-depth=2560 --param=modref-max-escape-points=2560 --param=modref-max-adjustments=80 --param=max-hoist-depth=300 --param=max-tail-merge-comparisons=100 --param=max-tail-merge-iterations=20 --param=max-store-chains-to-track=640 --param=max-stores-to-track=10240 --param=iv-consider-all-candidates-bound=400 --param=iv-max-considered-uses=2500 --param=dse-max-object-size=2560 --param=dse-max-alias-queries-per-store=2560 --param=scev-max-expr-size=1000 --param=scev-max-expr-complexity=100 --param=max-iterations-to-track=10000 --param=max-cse-path-length=300 --param=max-cse-insns=10000 --param=max-reload-search-insns=1000 --param=max-cselib-memory-locations=5000 --param=max-sched-ready-insns=1000 --param=max-sched-region-blocks=200 --param=max-pipeline-region-blocks=150 --param=max-sched-region-insns=1200 --param=max-pipeline-region-insns=2000 --param=selsched-max-lookahead=500 --param=selsched-max-sched-times=20 --param=selsched-insns-to-rename=20 --param=max-last-value-rtl=100000 --param=max-jump-thread-paths=640 --param=max-fields-for-field-sensitive=1000 --param=max-partial-antic-length=1000 --param=sccvn-max-alias-queries-per-access=10000 --param=ira-max-conflict-table-size=1500 --param=loop-invariant-max-bbs-in-loop=100000 --param=loop-max-datarefs-for-datadeps=10000 --param=max-vartrack-size=100000000 --param=max-vartrack-expr-depth=120 --param=ipa-sra-max-replacements=16 --param=sra-max-propagations=320 --param=ipa-jump-function-lookups=80 --param=ipa-cp-value-list-size=80 --param=ipa-max-aa-steps=250000 --param=ipa-max-switch-predicate-bounds=50 --param=ipa-max-param-expr-ops=100 --param=max-ssa-name-query-depth=10 --param=max-speculative-devirt-maydefs=500 --param=max-tracked-strlens=100000 --param=vrp-switch-limit=500 --param=uninit-control-dep-attempts=10000 --param=ranger-logical-depth=60 --param=ranger-recompute-depth=50 --param=relation-block-limit=2000 -std=gnu++2a -fopenmp-simd -g0 -fno-pie -flax-vector-conversions -march=x86-64-v4 -mmmx -msse -msse2 -msse3 -mssse3 -msse4 -msse4a -msse4.1 -msse4.2 -mavx -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq -mavx512ifma -mavx512vbmi -msha -maes -mpclmul -mclflushopt -mclwb -mfsgsbase -mptwrite -mrdrnd -mf16c -mfma -mpconfig -mwbnoinvd -mfma4 -mprfchw -mrdpid -mrdseed -msgx -mxop -mlwp -m3dnow -m3dnowa -mpopcnt -madx -mbmi -mbmi2 -mlzcnt -mfxsr -mxsave -mxsaveopt -mxsavec -mxsaves -mrtm -mtbm -mmwaitx -mclzero -mpku -mavx512vbmi2 -mavx512bf16 -mavx512fp16 -mgfni -mvaes -mwaitpkg -mvpclmulqdq -mavx512bitalg -mmovdiri -mmovdir64b -menqcmd -mtsxldtrk -mavx512vpopcntdq -mavx512vp2intersect -mavx512vnni -mavxvnni -mcldemote -mserialize -mamx-tile -mamx-int8 -mamx-bf16 -mhreset -mkl -mwidekl -mavxifma -mavxvnniint8 -mavxneconvert -mcmpccxadd -mamx-fp16 -mprefetchi -mraoint -mamx-complex -mavxvnniint16 -msm3 -msha512 -msm4 -musermsr -mavx10.1 -mavx10.1-256 -mavx10.1-512 -mcx16 -msahf -mmovbe -mshstk -mcrc32 -mevex512 -mprefer-vector-width=512' | process-flags-for-comm)
